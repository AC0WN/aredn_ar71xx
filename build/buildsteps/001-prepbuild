#!/bin/sh

cd "$BUILDROOTBASE"

# Prep the feeds file
echo "src-git arednpackages git://git.aredn.org/aredn_packages;develop" > feeds.conf
cat feeds.conf.default >> feeds.conf
./scripts/feeds update -a
./scripts/feeds install -p arednpackages olsrd
./scripts/feeds install perl
./scripts/feeds install -p arednpackages vtun
./scripts/feeds install -a -p arednpackages
./scripts/feeds install snmpd
./scripts/feeds install ntpclient
./scripts/feeds install socat
./scripts/feeds install xinetd

SHORT_COMMIT=$(echo "$GIT_COMMIT" | awk  '{ string=substr($0, 1, 8); print string; }' )
SHORT_BRANCH=$(echo "$GIT_BRANCH" | awk 'match($0,"/"){print substr($0,RSTART+1)}')

if [ ! -z "$BUILD_SET_VERSION" ]; then
  echo "$BUILD_SET_VERSION" > "$BUILDROOTBASE/files/etc/mesh-release"
else
  echo "${SHORT_BRANCH}-${BUILD_NUMBER}-${SHORT_COMMIT}" > "$BUILDROOTBASE/files/etc/mesh-release"
fi
